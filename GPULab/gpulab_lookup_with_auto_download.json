{
  "name": "lookup_table_with_auto_download",
  "description": "Generate lookup tables for NME fiber simulation with automatic download to local OneDrive folder",
  "request": {
    "resources": {
      "cpus": 4,
      "gpus": 0,
      "cpuMemoryGb": 8,
      "clusterId": 4
    },
    "docker": {
      "image": "python:3.12-slim",
      "command": "bash -c 'apt-get update && apt-get install -y git python3-tk build-essential cmake openssh-server && pip install neuron numpy scipy matplotlib tqdm colorlog lockfile pandas multiprocess boltons && cd /project_ghent && echo \"Installing PySONIC...\" && rm -rf PySONIC && git clone https://github.com/tjjlemaire/PySONIC.git && cd PySONIC && pip install -e . && cd .. && echo \"Installing MorphoSONIC...\" && rm -rf MorphoSONIC && git clone https://github.com/tjjlemaire/MorphoSONIC.git && cd MorphoSONIC && pip install -e . && echo \"Compiling NEURON mechanisms...\" && cd MorphoSONIC/nmodl && nrnivmodl && cd ../.. && echo \"MorphoSONIC installation completed.\" && cd .. && echo \"Preparing main repository directory...\" && rm -rf URENIMOD-lookups && git clone https://github.com/whizzkid-ox/URENIMOD-lookups.git && cd URENIMOD-lookups && echo \"Repository cloned successfully. Starting lookup generation...\" && python run_lookups.py -fiber_length 1e-3 -fiber_diameter 1e-6 -membrane_thickness 1.4e-9 -freq 1e6 -amp 1e6 -charge -65.0 && echo \"Lookup generation completed successfully!\" && echo \"\" && echo \"=== PREPARING FILES FOR AUTO-DOWNLOAD ===\" && mkdir -p /project_ghent/URENIMOD-data && LOOKUP_DIR=$(find /project_ghent/URENIMOD-lookups -name \"*unmyelinated_fiber_*\" -type d | head -1) && cd \"$LOOKUP_DIR\" && LOOKUP_FILE=$(ls *.pkl | head -1) && echo \"Found lookup file: $LOOKUP_FILE\" && echo \"File details:\" && ls -la \"$LOOKUP_FILE\" && echo \"File size: $(wc -c < \"$LOOKUP_FILE\") bytes\" && echo \"Copying to download directory...\" && cp \"$LOOKUP_FILE\" \"/project_ghent/URENIMOD-data/\" && echo \"\" && echo \"=== CREATING DOWNLOAD SCRIPT ===\" && cat > /project_ghent/URENIMOD-data/download_script.sh << \"EOF\"\n#!/bin/bash\necho \"=== Auto-Download Script for URENIMOD Lookup Tables ===\"\necho \"Job ID: $HOSTNAME\"\necho \"Timestamp: $(date)\"\necho \"Files ready for download:\"\nls -la /project_ghent/URENIMOD-data/*.pkl\necho \"\"\necho \"=== Base64 Encoded Files (for copy-paste method) ===\"\nfor file in /project_ghent/URENIMOD-data/*.pkl; do\n    if [ -f \"$file\" ]; then\n        echo \"File: $(basename \"$file\")\"\n        echo \"Size: $(wc -c < \"$file\") bytes\"\n        echo \"=== $(basename \"$file\") BASE64 START ===\"\n        base64 -w 0 \"$file\"\n        echo \"\"\n        echo \"=== $(basename \"$file\") BASE64 END ===\"\n        echo \"\"\n    fi\ndone\necho \"=== Download Instructions ===\"\necho \"1. Copy the base64 content above\"\necho \"2. Save to encoded.txt on your computer\"\necho \"3. Run: certutil -decode encoded.txt filename.pkl\"\necho \"4. Or use SSH/SFTP to download directly\"\nEOF\nchmod +x /project_ghent/URENIMOD-data/download_script.sh && echo \"\" && echo \"=== CREATING METADATA FILE ===\" && cat > /project_ghent/URENIMOD-data/job_metadata.json << EOF\n{\n  \"job_id\": \"$HOSTNAME\",\n  \"timestamp\": \"$(date -Iseconds)\",\n  \"lookup_file\": \"$LOOKUP_FILE\",\n  \"file_size\": $(wc -c < \"$LOOKUP_FILE\"),\n  \"parameters\": {\n    \"fiber_length\": \"1e-3\",\n    \"fiber_diameter\": \"1e-6\",\n    \"membrane_thickness\": \"1.4e-9\",\n    \"frequency\": \"1e6\",\n    \"amplitude\": \"1e6\",\n    \"charge\": \"-65.0\"\n  },\n  \"download_methods\": [\n    \"SSH/SFTP\",\n    \"Base64 copy-paste\",\n    \"Web interface\"\n  ]\n}\nEOF\necho \"\" && echo \"=== RUNNING DOWNLOAD SCRIPT ===\" && /project_ghent/URENIMOD-data/download_script.sh && echo \"\" && echo \"=== JOB COMPLETION SUMMARY ===\" && echo \"✅ Lookup tables generated successfully\" && echo \"✅ Files prepared for download at: /project_ghent/URENIMOD-data/\" && echo \"✅ Download script available\" && echo \"✅ Base64 encoding completed\" && echo \"\" && echo \"Files ready for download:\" && ls -la /project_ghent/URENIMOD-data/ && echo \"\" && echo \"=== KEEPING CONTAINER ALIVE FOR DOWNLOAD ===\" && echo \"Container will remain active for 30 minutes for file retrieval\" && echo \"Access via SSH: gpulab-cli --cert [cert] ssh [job-id]\" && echo \"Download via SFTP: gpulab-cli --cert [cert] sftp [job-id] --sftp\" && sleep 1800'",
      "storage": [
        {
          "containerPath": "/project_ghent"
        }
      ],
      "environment": {
        "PYTHONPATH": "/project_ghent/URENIMOD-lookups",
        "GITHUB_REPO": "https://github.com/whizzkid-ox/URENIMOD-lookups.git"
      }
    },
    "scheduling": {
      "interactive": false
    }
  }
}
